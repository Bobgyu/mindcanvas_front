import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import Chatbot from './Chatbot.jsx'
import axios from 'axios'

function MainPage() {
  const [count, setCount] = useState(0)
  const [isChatbotOpen, setIsChatbotOpen] = useState(false)

  const navigate = useNavigate()

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í† í° ê²€ì¦ (í•œ ë²ˆë§Œ ì‹¤í–‰)
  useEffect(() => {
    const token = localStorage.getItem('authToken');
    if (!token) {
      // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      navigate('/login');
      return;
    }

    // í† í°ì´ ìˆìœ¼ë©´ ë°”ë¡œ í†µê³¼ (ì„œë²„ ê²€ì¦ ìƒëµ)
    // JWT í† í°ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë§Œë£Œ ì‹œê°„ì„ ì²´í¬í•˜ì—¬ ë¡œì»¬ì—ì„œ ê²€ì¦
    try {
      const tokenData = JSON.parse(atob(token.split('.')[1]));
      const currentTime = Date.now() / 1000;
      if (tokenData.exp < currentTime) {
        // í† í°ì´ ë§Œë£Œë˜ì—ˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        navigate('/login');
        return;
      }
    } catch (error) {
      // í† í° íŒŒì‹± ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      navigate('/login');
      return;
    }
  }, [navigate]);

  const verifyToken = async () => {
    try {
      const token = localStorage.getItem('authToken');
      const response = await axios.post('http://localhost:5000/api/verify-token', {}, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });

      if (response.status !== 200) {
        // í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        navigate('/login');
      }
    } catch (err) {
      // í† í° ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      navigate('/login');
    }
  };

  const gotoMypage = () => {
    navigate('/mypage')   // ìƒëŒ€ê²½ë¡œ â†’ /mypage ë¡œ ì´ë™
  }

  const gotoHome = () => {
    navigate('/draw/home')   // ì§‘ ê·¸ë¦¬ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }

  const gotoTree = () => {
    navigate('/draw/tree')   // ë‚˜ë¬´ ê·¸ë¦¬ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }

  const gotoPerson = () => {
    navigate('/draw/person')   // ì‚¬ëŒ ê·¸ë¦¬ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }

  const gotoEmotionDiary = () => {
    navigate('/diary/emotion')   // ê°ì • ì¼ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }

  const gotoColorfill = () => {
    navigate('/draw/colorfill')   // ìƒ‰ì¹ í•˜ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }

  const openChatbot = () => {
    setIsChatbotOpen(true)
  }

  const closeChatbot = () => {
    setIsChatbotOpen(false)
  }

  return (
    <>
    <div className='options'>
      <div className='picture-options'>
        <h2 style={{ fontWeight: '800', fontSize: '24px', display: 'flex', alignItems: 'center', gap: '10px' }}>
          <span style={{
            display: 'inline-flex',
            alignItems: 'center',
            justifyContent: 'center',
            width: '44px',
            height: '44px',
            borderRadius: '50%',
            backgroundColor: '#CEF4E7',
            fontSize: '24px'
          }}>ğŸ§ </span>
          ê·¸ë¦¼ì‹¬ë¦¬í…ŒìŠ¤íŠ¸
        </h2>
        <button className='option' onClick={gotoHome}>
          <img src="/src/imgdata/icon/home.png" alt="ì§‘" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          ì§‘
        </button>
        <button className='option' onClick={gotoTree}>
          <img src="/src/imgdata/icon/tree.png" alt="ë‚˜ë¬´" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          ë‚˜ë¬´
        </button>
        <button className='option' onClick={gotoPerson}>
          <img src="/src/imgdata/icon/person.png" alt="ì‚¬ëŒ" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          ì‚¬ëŒ
        </button>
      </div>
      {/* ì„¹ì…˜ êµ¬ë¶„ì„  (Primary) */}
      <div style={{
        width: '80%',
        height: '2px',
        backgroundColor: 'rgb(39, 192, 141)',
        borderRadius: '1px',
        margin: '8px auto 0'
      }} />

      <div className='draw-options'>
        <h2 style={{ fontWeight: '800', fontSize: '24px', display: 'flex', alignItems: 'center', gap: '10px' }}>
          <span style={{
            display: 'inline-flex',
            alignItems: 'center',
            justifyContent: 'center',
            width: '44px',
            height: '44px',
            borderRadius: '50%',
            backgroundColor: '#CEF4E7',
            fontSize: '24px'
          }}>ğŸ¨</span>
          ì•„íŠ¸í…Œë¼í”¼
        </h2>
        <button className='option' onClick={gotoEmotionDiary}>
          <img src="/src/imgdata/icon/diary.png" alt="ë§ˆìŒì¼ê¸°" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          ë§ˆìŒì¼ê¸°
        </button>
        <button className='option' onClick={gotoColorfill}>
          <img src="/src/imgdata/icon/Painter.png" alt="ìƒ‰ì¹ í•˜ê¸°" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          ìƒ‰ì¹ í•˜ê¸°
        </button>
        <button className='option'>
          <img src="/src/imgdata/icon/drawcanvas.png" alt="í…Œë§ˆê·¸ë¦¬ê¸°" style={{ width: '48px', height: '48px', marginRight: '20px' }} />
          í…Œë§ˆê·¸ë¦¬ê¸°
        </button>
      </div>
    </div>
    {/* ë„¤ë¹„ê²Œì´ì…˜ ë°” ì™¸ë¶€ ì»¨í…Œì´ë„ˆ */}
    <div style={{
      backgroundColor: 'rgb(39, 192, 141)',
      borderRadius: '50px',
      margin: '20px auto',
      width: '80%',
      height: '70px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }}>
      {/* ë‚´ë¶€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-around',
        alignItems: 'center',
        width: '100%',
        padding: '0px 20px',
        height: '100%'
      }}>
        <button className='lower-option' style={{
          backgroundColor: '#CEF4E7',
          border: 'none',
          borderRadius: '50%',
          padding: '4px 0px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '50px',
          height: '50px'
        }}>
          <img src="/src/imgdata/icon/PAINT BRUSH.png" alt="ê·¸ë¦¬ê¸°" style={{ width: '32px', height: '32px' }} />
        </button>
        <button className='lower-option' style={{
          backgroundColor: '#CEF4E7',
          border: 'none',
          borderRadius: '50%',
          padding: '4px 0px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '50px',
          height: '50px'
        }}>
          <img src="/src/imgdata/icon/chat.png" alt="ì±„íŒ…" style={{ width: '32px', height: '32px' }} />
        </button>
        <button className='lower-option' onClick={openChatbot} style={{
          backgroundColor: '#CEF4E7',
          border: 'none',
          borderRadius: '50%',
          padding: '4px 0px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '50px',
          height: '50px'
        }}>
          <img src="/src/imgdata/icon/chatbot.png" alt="ì±—ë´‡" style={{ width: '36px', height: '36px' }} />
        </button>
        <button className='lower-option' onClick={gotoMypage} style={{
          backgroundColor: '#CEF4E7',
          border: 'none',
          borderRadius: '50%',
          padding: '4px 0px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '50px',
          height: '50px'
        }}>
          <img src="/src/imgdata/icon/user.png" alt="ë§ˆì´í˜ì´ì§€" style={{ width: '32px', height: '32px' }} />
        </button>
      </div>
    </div>
    
    {/* ì±—ë´‡ ëª¨ë‹¬ */}
    <Chatbot isOpen={isChatbotOpen} onClose={closeChatbot} />
    </>
  )
}

export default MainPage